# .github/workflows/experiments.yml
name: experiments

on:
  workflow_dispatch:
    inputs:
      P:
        description: "Primorial (30, 210, 2310)"
        required: true
        default: "2310"
      A:
        description: "Window start"
        required: true
        default: "1000000"
      B:
        description: "Window end"
        required: true
        default: "1100000"
      seed:
        description: "Seed"
        required: true
        default: "42"

jobs:
  run-exp:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi

      - name: Run experiment
        env:
          P: ${{ inputs.P }}
          A: ${{ inputs.A }}
          B: ${{ inputs.B }}
          SEED: ${{ inputs.seed }}
        run: |
          mkdir -p results/gha
          python -m guasti.experiment \
            --P "$P" \
            --A "$A" \
            --B "$B" \
            --seed "$SEED" \
            --out "results/gha"

      - name: Build report.md
        run: |
          python -m guasti.report \
            --in "results/gha" \
            --out "results/gha/report.md"

      - name: Upload artifacts (results)
        uses: actions/upload-artifact@v4
        with:
          name: guasti-results-P${{ inputs.P }}-A${{ inputs.A }}-B${{ inputs.B }}
          path: results/gha
          if-no-files-found: error
